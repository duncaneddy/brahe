name: Test Rust
on: [ workflow_call ]
jobs:
    build-rust:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                rust-toolchain: [nightly]
        env:
            CARGO_TERM_COLOR: always
        steps:
            -   uses: actions/checkout@v5
            -   name: Set up Rust toolchain with cache
                uses: actions-rust-lang/setup-rust-toolchain@v1
                with:
                    toolchain: ${{ matrix.rust-toolchain }}
            -   name: Set default Rust toolchain
                run: |
                    rustup update ${{ matrix.rust-toolchain }}
                    rustup default ${{ matrix.rust-toolchain }}
            -   name: Build Rust package
                run: cargo build
            -   name: Upload Rust build artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: rust-build-artifacts-${{ runner.os }}
                    path: |
                        target/debug/
                        !target/debug/incremental/
                        !target/debug/deps/*.d
                        !target/debug/deps/*.rmeta
                        !target/debug/.fingerprint/
                    retention-days: 3
    test-rust:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                rust-toolchain: [nightly]
        needs: build-rust
        environment: release
        env:
            CARGO_TERM_COLOR: always
        steps:
            -   uses: actions/checkout@v5
            -   name: Set up Rust toolchain with cache
                uses: actions-rust-lang/setup-rust-toolchain@v1
                with:
                    toolchain: ${{ matrix.rust-toolchain }}
            -   name: Set default Rust toolchain
                run: |
                    rustup update ${{ matrix.rust-toolchain }}
                    rustup default ${{ matrix.rust-toolchain }}
            -   name: Download Rust build artifacts
                uses: actions/download-artifact@v4
                with:
                    name: rust-build-artifacts-${{ runner.os }}
                    path: target/debug/
            -   name: Install cargo-llvm-cov
                uses: taiki-e/install-action@cargo-llvm-cov
            -   name: Run Rust tests with coverage
                run: cargo llvm-cov --workspace --lcov --output-path lcov.info --features ci
            -   name: Upload coverage to Codecov
                uses: codecov/codecov-action@v5
                with:
                    token: ${{ secrets.CODECOV_TOKEN }}
                    files: lcov.info
                    fail_ci_if_error: false # TODO: Change to true
    test-rust-docs:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                rust-toolchain: [nightly]
        needs: build-rust
        steps:
            -   uses: actions/checkout@v5
            -   name: Set up Rust toolchain with cache
                uses: actions-rust-lang/setup-rust-toolchain@v1
                with:
                    toolchain: ${{ matrix.rust-toolchain }}
            -   name: Set default Rust toolchain
                run: |
                    rustup update ${{ matrix.rust-toolchain }}
                    rustup default ${{ matrix.rust-toolchain }}
            -   name: Download Rust build artifacts
                uses: actions/download-artifact@v4
                with:
                    name: rust-build-artifacts-${{ runner.os }}
                    path: target/debug/
            -   name: Run Rust doc tests
                run: cargo test --doc --features ci
    pre-cache-python:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                python-version: [ '3.9', '3.10', '3.11', '3.12', '3.13', '3.14' ]
                rust-toolchain: [nightly]
        steps:
            -   uses: actions/checkout@v5
            -   name: Set up Rust toolchain
                uses: actions-rust-lang/setup-rust-toolchain@v1
                with:
                    toolchain: ${{ matrix.rust-toolchain }}
            -   name: Set default Rust toolchain
                run: |
                    rustup update ${{ matrix.rust-toolchain }}
                    rustup default ${{ matrix.rust-toolchain }}
            -   name: Install the latest version of uv
                uses: astral-sh/setup-uv@v7
                with:
                    enable-cache: true
            -   name: Install Python ${{ matrix.python-version }}
                run: uv python install ${{ matrix.python-version }}

            -   name: Install dependencies
                run: uv sync --all-extras --frozen --python python
    build-python-extension:
        runs-on: ${{ matrix.os }}
        needs: build-rust
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                python-version: [ '3.9', '3.10', '3.11', '3.12', '3.13', '3.14' ]
                rust-toolchain: [nightly]
        steps:
            -   uses: actions/checkout@v5
            -   name: Set up Rust toolchain with cache
                uses: actions-rust-lang/setup-rust-toolchain@v1
                with:
                    toolchain: ${{ matrix.rust-toolchain }}
            -   name: Set default Rust toolchain
                run: |
                    rustup update ${{ matrix.rust-toolchain }}
                    rustup default ${{ matrix.rust-toolchain }}
            -   name: Download Rust build artifacts
                uses: actions/download-artifact@v4
                with:
                    name: rust-build-artifacts-${{ runner.os }}
                    path: target/debug/
            -   name: Install the latest version of uv
                uses: astral-sh/setup-uv@v7
                with:
                    enable-cache: true
            -   name: Install Python ${{ matrix.python-version }}
                run: uv python install ${{ matrix.python-version }}

            -   name: Install dependencies
                run: uv sync --all-extras --frozen --python python
            -   name: Build Python extension (release mode)
                run: uv pip install -e .
            -   name: Find and upload Python extension artifact (Unix)
                if: runner.os != 'Windows'
                shell: bash
                run: |
                    # Find the built extension (.so on Linux, .dylib on Mac)
                    EXTENSION=$(find target/release -maxdepth 1 \( -name "libbrahe.so" -o -name "libbrahe.dylib" \) | head -1)
                    if [ -z "$EXTENSION" ]; then
                        echo "Error: Could not find built Python extension"
                        exit 1
                    fi
                    echo "Found extension: $EXTENSION"
                    mkdir -p artifact-output
                    cp "$EXTENSION" artifact-output/
            -   name: Find and upload Python extension artifact (Windows)
                if: runner.os == 'Windows'
                shell: pwsh
                run: |
                    # Find the built extension (.pyd on Windows)
                    $extension = Get-ChildItem -Path target/release -Filter "libbrahe.pyd" -File -ErrorAction SilentlyContinue | Select-Object -First 1
                    if (-not $extension) {
                        Write-Error "Error: Could not find built Python extension"
                        exit 1
                    }
                    Write-Output "Found extension: $($extension.FullName)"
                    New-Item -ItemType Directory -Force -Path artifact-output
                    Copy-Item $extension.FullName artifact-output/
            -   name: Upload Python extension
                uses: actions/upload-artifact@v4
                with:
                    name: python-extension-${{ runner.os }}-py${{ matrix.python-version }}
                    path: artifact-output/
                    retention-days: 7