name: PR Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'news/**'
      - 'CHANGELOG.md'

jobs:
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'changelog') }}" == "true" ]] || \
             [[ "${{ contains(github.event.pull_request.labels.*.name, 'automated') }}" == "true" && "${{ github.actor }}" == "github-actions[bot]" ]]; then
            echo "Skipping tests for automated changelog PR"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "Running tests for normal PR"
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

  test-rust:
    needs: [check-skip]
    if: needs.check-skip.outputs.should_skip == 'false'
    uses: ./.github/workflows/test_rust.yml

  test-python:
    needs: [check-skip, test-rust]
    if: needs.check-skip.outputs.should_skip == 'false'
    uses: ./.github/workflows/test_python.yml

  test-examples:
    needs: [check-skip, test-rust]
    if: needs.check-skip.outputs.should_skip == 'false'
    uses: ./.github/workflows/test_examples.yml

  # Validate crates.io package builds correctly and is under size limit
  validate-rust-package:
    runs-on: ubuntu-latest
    needs: [check-skip, test-rust]
    if: needs.check-skip.outputs.should_skip == 'false'
    env:
      RUST_TOOLCHAIN: nightly
    steps:
      - uses: actions/checkout@v5

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Set default Rust toolchain
        run: |
          rustup update ${{ env.RUST_TOOLCHAIN }}
          rustup default ${{ env.RUST_TOOLCHAIN }}

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Python 3.14
        run: uv python install 3.14

      - name: Build and validate Rust package
        run: uv run python make.py build --lang rust

  # Validate PyPI packages build correctly with proper metadata
  validate-python-package:
    runs-on: ubuntu-latest
    needs: [check-skip, test-python]
    if: needs.check-skip.outputs.should_skip == 'false'
    env:
      RUST_TOOLCHAIN: nightly
    steps:
      - uses: actions/checkout@v5

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Set default Rust toolchain
        run: |
          rustup update ${{ env.RUST_TOOLCHAIN }}
          rustup default ${{ env.RUST_TOOLCHAIN }}

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Python 3.14
        run: uv python install 3.14

      - name: Build and validate Python package
        run: uv run python make.py build --lang python

  # Build docs to verify no breakage, but don't deploy
  build-docs:
    runs-on: ubuntu-latest
    needs: [check-skip, test-python, test-examples]
    if: needs.check-skip.outputs.should_skip == 'false'
    env:
      RUST_TOOLCHAIN: nightly
    steps:
      - uses: actions/checkout@v5

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Set default Rust toolchain
        run: |
          rustup update ${{ env.RUST_TOOLCHAIN }}
          rustup default ${{ env.RUST_TOOLCHAIN }}

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Python 3.14
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync --group docs --all-extras --frozen

      - name: Build Python extension
        run: uv pip install -e .

      - name: Generate type stubs
        run: ./scripts/generate_stubs.sh

      # Download artifacts from test-examples
      - name: Download test-examples artifacts
        uses: actions/download-artifact@v6
        with:
          name: doc-figures
          path: docs/figures/

      - name: Build documentation (verify only, no deployment)
        run: uv run mkdocs build
