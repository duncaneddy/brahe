name: Publish Version Release

on:
  push:
    tags:
      - v[0-9].[0-9]+.[0-9]+

jobs:
  # Validate that tag version matches package versions
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract version from tag
        id: extract
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Validate Cargo.toml version
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          if [ "$CARGO_VERSION" != "${{ steps.extract.outputs.version }}" ]; then
            echo "ERROR: Tag version (${{ steps.extract.outputs.version }}) does not match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi
          echo "Cargo.toml version matches: $CARGO_VERSION"

      - name: Validate pyproject.toml version
        run: |
          # pyproject.toml version is dynamic, synced to Cargo.toml, so just verify Cargo.toml is correct
          echo "Python version is dynamic and synced to Cargo.toml"

  test-rust:
    uses: ./.github/workflows/test_rust.yml
    needs: [validate-version]

  test-python:
    uses: ./.github/workflows/test_python.yml
    needs: [validate-version]

  test-examples:
    uses: ./.github/workflows/test_examples.yml
    needs: [validate-version]

  # Generate release notes using towncrier
  generate-release-notes:
    runs-on: ubuntu-latest
    needs: [validate-version, test-rust, test-python, test-examples]
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Python
        run: uv python install 3.12

      - name: Create virtual environment
        run: uv venv

      - name: Install towncrier
        run: uv pip install towncrier

      - name: Check for changelog fragments
        id: check-fragments
        run: |
          if [ -n "$(find news/ -maxdepth 1 -name '*.md' ! -name '.template.md' ! -name 'README.md' -type f)" ]; then
            echo "has_fragments=true" >> $GITHUB_OUTPUT
            echo "Found changelog fragments"
          else
            echo "has_fragments=false" >> $GITHUB_OUTPUT
            echo "No changelog fragments found"
          fi

      - name: Generate release notes
        if: steps.check-fragments.outputs.has_fragments == 'true'
        run: |
          VERSION=${{ needs.validate-version.outputs.version }}
          uv run towncrier build --version $VERSION --yes
          echo "Release notes generated for version $VERSION"

      - name: Create empty release notes
        if: steps.check-fragments.outputs.has_fragments == 'false'
        run: |
          VERSION=${{ needs.validate-version.outputs.version }}
          echo "No significant changes for this release." > release_notes.md
          echo "No changelog fragments found - created empty release notes"

      - name: Create Pull Request for CHANGELOG update
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update CHANGELOG for v${{ needs.validate-version.outputs.version }}"
          branch: release-changelog-v${{ needs.validate-version.outputs.version }}
          delete-branch: true
          title: "Update CHANGELOG for v${{ needs.validate-version.outputs.version }}"
          body: |
            Auto-generated CHANGELOG update for release v${{ needs.validate-version.outputs.version }}

            This PR updates the CHANGELOG and removes consumed changelog fragments.

            This PR can be auto-merged.
          labels: changelog,automated,release

      - name: Extract release notes for this version
        if: steps.check-fragments.outputs.has_fragments == 'true'
        run: |
          VERSION=${{ needs.validate-version.outputs.version }}
          # Extract the section for this version from CHANGELOG.md
          awk "/^## v?$VERSION/,/^## /" CHANGELOG.md | head -n -1 > release_notes.md
          echo "Extracted release notes:"
          cat release_notes.md

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v5
        with:
          name: release-notes
          path: release_notes.md

      - name: Upload CHANGELOG artifact
        uses: actions/upload-artifact@v5
        with:
          name: changelog
          path: CHANGELOG.md

  update-docs:
    uses: ./.github/workflows/update_docs.yml
    needs: [generate-release-notes]
    with:
      version: ${{ github.ref_name }}

  python-build-source:
    needs: [generate-release-notes]
    runs-on: ubuntu-latest
    environment: release
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.12']
        rust-toolchain: [nightly]

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download CHANGELOG
      uses: actions/download-artifact@v4
      with:
        name: changelog

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.rust-toolchain }}

    - name: Set default Rust toolchain
      run: |
        rustup update ${{ matrix.rust-toolchain }}
        rustup default ${{ matrix.rust-toolchain }}

    - name: Install the latest version of uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Install Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Create virtual environment
      run: uv venv -p ${{ matrix.python-version }}

    - name: Activate virtual environment
      run: source .venv/bin/activate

    - name: Install build
      run: uv pip install -U build

    - name: Build source distribution
      run: uv run python -m build --sdist

    - name: Upload artifact
      uses: actions/upload-artifact@v5
      with:
        path: dist/*.tar.gz
        name: brahe-${{ github.ref_name }}-${{ runner.os }}-source

  python-build-wheels:
    needs: [generate-release-notes]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
          os: [ubuntu-latest, macos-latest, windows-latest]
          python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
          rust-toolchain: [nightly]
    environment: release

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.rust-toolchain }}

    - name: Set default Rust toolchain
      run: |
        rustup update ${{ matrix.rust-toolchain }}
        rustup default ${{ matrix.rust-toolchain }}

    - name: Install the latest version of uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Install Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Build wheel with maturin
      uses: PyO3/maturin-action@v1
      with:
        command: build
        rust-toolchain: ${{ matrix.rust-toolchain }}
        args: --release -i python${{ matrix.python-version }}

    - name: Upload artifact
      uses: actions/upload-artifact@v5
      with:
        path: target/wheels/*.whl
        name: brahe-${{ github.ref_name }}-python${{ matrix.python-version }}-${{ runner.os }}-wheel

  release-python:
    needs: [python-build-source, python-build-wheels]
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write

    steps:
    # Download all artifacts to dist folder
    - name: Download artifacts
      uses: actions/download-artifact@v4

    - name: Copy artifacts to dist folder
      run: |
        mkdir dist
        cp -r ${{ github.workspace }}/*-source/* dist/
        cp -r ${{ github.workspace }}/*-wheel/* dist/

    - name: Upload package to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1

  release-rust:
    runs-on: ubuntu-latest
    needs: [python-build-source, python-build-wheels]
    environment: release
    permissions:
      id-token: write
    env:
      RUST_TOOLCHAIN: nightly
    steps:
      - uses: actions/checkout@v5
      - name: Download CHANGELOG
        uses: actions/download-artifact@v4
        with:
          name: changelog
      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      - name: Set default Rust toolchain
        run: |
          rustup update ${{ env.RUST_TOOLCHAIN }}
          rustup default ${{ env.RUST_TOOLCHAIN }}
      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Create GitHub Release as draft with all artifacts
  create-github-release:
    runs-on: ubuntu-latest
    needs: [release-python, release-rust, update-docs, validate-version]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare artifacts for release
        run: |
          mkdir -p release-artifacts
          cp -r *-source/* release-artifacts/ 2>/dev/null || true
          cp -r *-wheel/* release-artifacts/ 2>/dev/null || true
          ls -lah release-artifacts/

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes

      - name: Create draft GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: release_notes.md
          draft: true
          prerelease: false
          files: release-artifacts/*

  # Update the "latest" release tag and artifacts
  update-latest-release:
    runs-on: ubuntu-latest
    needs: [create-github-release, validate-version]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare and rename artifacts for latest release
        run: |
          mkdir -p release-artifacts

          # Copy and rename wheels to include "latest" instead of version
          for wheel in *-wheel/*.whl; do
            if [ -f "$wheel" ]; then
              filename=$(basename "$wheel")
              # Replace version pattern (e.g., 0.1.0, 1.2.3) with "latest"
              new_filename=$(echo "$filename" | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+(-|\.whl)/-latest\1/')
              cp -v "$wheel" "release-artifacts/$new_filename"
            fi
          done

          # Copy and rename source distribution to include "latest" instead of version
          for sdist in *-source/*.tar.gz; do
            if [ -f "$sdist" ]; then
              filename=$(basename "$sdist")
              # Replace version pattern with "latest"
              new_filename=$(echo "$filename" | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+\.tar\.gz/-latest.tar.gz/')
              cp -v "$sdist" "release-artifacts/$new_filename"
            fi
          done

          echo "Renamed artifacts for latest release:"
          ls -lah release-artifacts/

      - name: Update latest tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -fa latest -m "Latest stable release: ${{ github.ref_name }}"
          git push origin latest --force

      - name: Update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Release (${{ github.ref_name }})
          body: |
            This is the latest stable release of Brahe.

            Current version: **${{ github.ref_name }}** (v${{ needs.validate-version.outputs.version }})

            For detailed release notes, see the [versioned release](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}).
          draft: false
          prerelease: true
          files: release-artifacts/*
