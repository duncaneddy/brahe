name: Test Rust
on: [ workflow_call ]
jobs:
    build-rust:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                # os: [ubuntu-latest]
                os: [ubuntu-latest, macos-latest, windows-latest]
                rust-toolchain: [nightly]
        env:
            CARGO_TERM_COLOR: always
        steps:
            -   uses: actions/checkout@v6
            -   name: Set up Rust toolchain with cache
                uses: actions-rust-lang/setup-rust-toolchain@v1
                with:
                    toolchain: ${{ matrix.rust-toolchain }}
            -   name: Set default Rust toolchain
                run: |
                    rustup update ${{ matrix.rust-toolchain }}
                    rustup default ${{ matrix.rust-toolchain }}
            -   name: Build Rust package
                run: cargo build
            -   name: Upload Rust build artifacts
                uses: actions/upload-artifact@v6
                with:
                    name: rust-build-artifacts-${{ runner.os }}
                    path: |
                        target/debug/
                        !target/debug/incremental/
                        !target/debug/deps/*.d
                        !target/debug/deps/*.rmeta
                        !target/debug/.fingerprint/
                    retention-days: 3
    test-rust:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                # os: [ubuntu-latest]
                os: [ubuntu-latest, macos-latest, windows-latest]
                rust-toolchain: [nightly]
        needs: build-rust
        environment: release
        permissions:
            id-token: write
        env:
            CARGO_TERM_COLOR: always
        steps:
            -   uses: actions/checkout@v6
            -   name: Set up Rust toolchain with cache
                uses: actions-rust-lang/setup-rust-toolchain@v1
                with:
                    toolchain: ${{ matrix.rust-toolchain }}
            -   name: Set default Rust toolchain
                run: |
                    rustup update ${{ matrix.rust-toolchain }}
                    rustup default ${{ matrix.rust-toolchain }}
            -   name: Download Rust build artifacts
                uses: actions/download-artifact@v7
                with:
                    name: rust-build-artifacts-${{ runner.os }}
                    path: target/debug/
            -   name: Install cargo-llvm-cov
                uses: taiki-e/install-action@cargo-llvm-cov
            -   name: Run Rust tests with coverage
                run: cargo llvm-cov --workspace --lcov --output-path lcov.info --features ci
            -   name: Upload coverage to Codecov
                if: matrix.os == 'ubuntu-latest'
                uses: codecov/codecov-action@v5.5.2
                env:
                    CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
                with:
                    fail_ci_if_error: false
                    verbose: true
                    use_oidc: true
                    
            -   name: Upload Brahe cache directory (Unix)
                if: runner.os != 'Windows'
                uses: actions/upload-artifact@v6
                with:
                    name: brahe-cache-${{ runner.os }}
                    path: ~/.cache/brahe/
                    retention-days: 1
                    if-no-files-found: ignore
            -   name: Upload Brahe cache directory (Windows)
                if: runner.os == 'Windows'
                uses: actions/upload-artifact@v6
                with:
                    name: brahe-cache-${{ runner.os }}
                    path: ~\\.cache\\brahe\\
                    retention-days: 1
                    if-no-files-found: ignore
    test-rust-docs:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                # os: [ubuntu-latest]
                os: [ubuntu-latest, macos-latest, windows-latest]
                rust-toolchain: [nightly]
        needs: build-rust
        steps:
            -   uses: actions/checkout@v6
            -   name: Set up Rust toolchain with cache
                uses: actions-rust-lang/setup-rust-toolchain@v1
                with:
                    toolchain: ${{ matrix.rust-toolchain }}
            -   name: Set default Rust toolchain
                run: |
                    rustup update ${{ matrix.rust-toolchain }}
                    rustup default ${{ matrix.rust-toolchain }}
            -   name: Download Rust build artifacts
                uses: actions/download-artifact@v7
                with:
                    name: rust-build-artifacts-${{ runner.os }}
                    path: target/debug/
            -   name: Run Rust doc tests
                run: cargo test --doc --features ci -- --test-threads=1
    