name: Test Python
on: [ workflow_call ]
jobs:
    test-python:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-latest ]
                python-version: [ '3.9', '3.10', '3.11', '3.12', '3.13', '3.14' ]
        steps:
            # TODO: Remove this when the nightly BTreeCursor is stabilized and released
            -   name: Install Rust
                run: rustup update nightly
            -   run: rustup default nightly
            -   uses: actions/checkout@v5
            -   name: Install the latest version of uv and set the python version
                uses: astral-sh/setup-uv@v6
                with:
                    python-version: ${{ matrix.python-version }}
                    enable-cache: trueuv 
            -   name: Install dependencies
                run: uv sync --all-extras --frozen

            -   name: Test with python ${{ matrix.python-version }}
                run: uv run --frozen coverage run -m pytest

            -   name: Generate coverage report
                run: uv run --frozen coverage report

    test-python-network:
        runs-on: ubuntu-latest
        needs: test-python
        steps:
            # TODO: Remove this when the nightly BTreeCursor is stabilized and released
            -   name: Install Rust
                run: rustup update nightly
            -   run: rustup default nightly
            -   uses: actions/checkout@v5
            -   name: Install the latest version of uv and set the python version
                uses: astral-sh/setup-uv@v6
                with:
                    python-version: '3.14'
                    enable-cache: true
            -   name: Install dependencies
                run: uv sync --all-extras --frozen

            -   name: Test network-dependent tests with Python 3.14
                run: uv run --frozen pytest -m network
