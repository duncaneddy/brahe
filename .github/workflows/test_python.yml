name: Test Python
on: [ workflow_call ]
jobs:
    test-python:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                python-version: [ '3.9', '3.10', '3.11', '3.12', '3.13', '3.14' ]
        steps:
            # TODO: Remove this when the nightly BTreeCursor is stabilized and released
            -   name: Install Rust
                run: rustup update nightly
            -   run: rustup default nightly
            -   uses: actions/checkout@v5
            -   name: Install the latest version of uv and set the python version
                uses: astral-sh/setup-uv@v6
                with:
                    python-version: ${{ matrix.python-version }}
                    enable-cache: true

            # Cache the virtual environment to avoid reinstalling dependencies
            -   name: Cache virtual environment
                uses: actions/cache@v4
                with:
                    path: .venv
                    key: venv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}
                    restore-keys: |
                        venv-${{ runner.os }}-py${{ matrix.python-version }}-

            # Try to download Brahe cache to avoid external API calls
            -   name: Download Brahe cache directory
                id: download-cache
                continue-on-error: true
                uses: actions/download-artifact@v4
                with:
                    name: brahe-cache
                    path: ~/.cache/brahe/

            # Try to download pre-built Python extension for this Python version
            -   name: Download Python extension artifact
                id: download-extension
                continue-on-error: true
                uses: actions/download-artifact@v4
                with:
                    name: python-extension-${{ runner.os }}-py${{ matrix.python-version }}
                    path: ./cached-extension

            -   name: Install dependencies and Python package
                run: |
                    # Sync dependencies first
                    uv sync --all-extras --frozen

                    # Then install the brahe package
                    if [ -d "./cached-extension" ] && [ -f "./cached-extension/libbrahe"* ]; then
                        echo "Using cached Python extension"
                        mkdir -p target/release
                        cp ./cached-extension/libbrahe* target/release/
                        # Install maturin for --no-build-isolation
                        uv pip install maturin
                        uv pip install -e . --no-build-isolation
                    else
                        echo "Building Python extension (no cache available)"
                        uv pip install -e .
                    fi

            -   name: Test with python ${{ matrix.python-version }}
                run: uv run --frozen coverage run -m pytest -m ''

            -   name: Generate coverage report
                run: uv run --frozen coverage report

